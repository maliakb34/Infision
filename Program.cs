using Infision;
using Infision.PayloadBuilder.Builders;
using Infision.PayloadBuilder.Models;
using Infision.PayloadBuilder.Util;
using System;
using System.Net;
using System.Net.Sockets;
using System.Text;
using System.Text.Json;
using System.Threading;
using System.Threading.Tasks;
using System.Xml.Linq;
record VariantConfig(
    ushort Sequence,
    string FirstName,
    string LastName,
    int Age,
    float Height,
    float Weight,
    int BloodType);
class Program
{
    static async Task Main()
    {
        const int port = 9903;
        const string ip = "192.168.1.37"; // tüm arayüzlerde dinle
        const string targetIP = "192.168.1.43"; // cihaz IP'si

        var listener = new TcpListener(IPAddress.Parse(ip), port);
        listener.Start();
    
        using var client = await listener.AcceptTcpClientAsync();
        Console.WriteLine("[?] Cihaz bağlandı!");

        var stream = client.GetStream();
        // 1. Listen for handshake message
        byte[] buffer = new byte[4096];
        int bytesRead = stream.Read(buffer, 0, buffer.Length);

        // 2. Parse the handshake message
        Console.WriteLine("Received handshake (hex): " +
            BitConverter.ToString(buffer, 0, bytesRead).Replace("-", " ")
            );

        // Example: Check if the message matches expected handshake
        byte[] expectedHandshake = new byte[]
        {
                    0xFA, 0x05, 0x41, 0xC7, 0x0A, 0x00, 0x02, 0x00, 0x08, 0x01,
                    0xFA, 0x05, 0x41, 0xC7, 0x0A, 0x00, 0x02, 0x00, 0x08, 0x01
        };

        Console.WriteLine("Received handshake (hex): " +
                       BitConverter.ToString(buffer, 0, bytesRead).Replace("-", " "));

        // 3. Eğer ilk 10 byte beklenen handshake ise cevap gönder
        if (bytesRead >= 10 &&
            buffer[0] == 0xFA && buffer[1] == 0x05 && buffer[2] == 0x41 && buffer[3] == 0xC7 &&
            buffer[4] == 0x0A && buffer[5] == 0x00 && buffer[6] == 0x02 && buffer[7] == 0x00 &&
            buffer[8] == 0x08 && buffer[9] == 0x01)
        {
            // Cevap olarak aynı mesajı gönderiyoruz
            byte[] reply = new byte[10];
            Array.Copy(buffer, reply, 10);
            stream.Write(reply, 0, reply.Length);
            Console.WriteLine("Handshake reply sent (hex): " +
                BitConverter.ToString(reply).Replace("-", " "));
        }
        else
        {
            Console.WriteLine("Unexpected handshake message.");
        }




        // === 4) Hasta bilgisi güncelleme paketi (Frame 494) ===
        await Task.Delay(3000); // 3 saniye bekle





        byte[] q = new byte[]
        {
0x02, 0x00, 0x00, 0x2B, 0x00, 0x27, 0xD0, 0x39, 0x57, 0x08, 0xD4, 0x81, 0x08, 0x00, 0x45, 0x00,
0x00, 0xAD, 0x85, 0x88, 0x40, 0x00, 0x80, 0x06, 0xF1, 0x26, 0xC0, 0xA8, 0x01, 0x23, 0xC0, 0xA8,
0x01, 0x28, 0x26, 0xAF, 0x26, 0xAF, 0x76, 0x42, 0xCB, 0x5C, 0x01, 0x4B, 0xAF, 0x78, 0x50, 0x18,
0xFB, 0x79, 0xA5, 0x41, 0x00, 0x00, 0xFA, 0x05, 0x5F, 0xB4, 0x79, 0x00, 0x0A, 0x00, 0x08, 0x84,
0x20, 0x10, 0x02, 0x18, 0xE1, 0x01, 0x28, 0x01, 0x0A, 0x20, 0x41, 0x45, 0x38, 0x32, 0x44, 0x36,
0x32, 0x35, 0x32, 0x31, 0x42, 0x43, 0x34, 0x41, 0x31, 0x32, 0x39, 0x34, 0x33, 0x34, 0x44, 0x31,
0x38, 0x30, 0x37, 0x42, 0x46, 0x35, 0x38, 0x33, 0x32, 0x45, 0x12, 0x02, 0x4D, 0x41, 0x1A, 0x01,
0x31, 0x22, 0x0C, 0x70, 0x69, 0x64, 0x39, 0x30, 0x39, 0x38, 0x37, 0x36, 0x31, 0x32, 0x33, 0x2A,
0x07, 0x76, 0x69, 0x64, 0x31, 0x32, 0x33, 0x34, 0x32, 0x03, 0x44, 0x6F, 0x65, 0x3A, 0x04, 0x4A, 0x6F, 0x68, 0x6E, 0x40, 0x01,
0x48, 0x21, 0x50, 0x01, 0x5D, 0x00, 0x00, 0x2E, 0x43, 0x65, 0x00, 0x00, 0xA6, 0x42, 0x68, 0x03,
0x81, 0x01, 0xE0, 0xD7, 0x24, 0x88, 0x99, 0x01, 0x00, 0x00
        };


        byte[] w = new byte[]
{

0x02,0x00,0x00,0x2B,0x00,0x27,0xD0,0x39,0x57,0x08,0xD4,0x81,0x08,0x00,0x45,0x00,
0x00,0xAD,0x85,0x88,0x40,0x00,0x80,0x06,0xF1,0x26,0xC0,0xA8,0x01,0x23,0xC0,0xA8,
0x01,0x28,0x26,0xAF,0x26,0xAF,0x76,0x42,0xCB,0x5C,0x01,0x4B,0xAF,0x78,0x50,0x18,
0xFB,0x79,0xA5,0x41,0x00,0x00,0xFA,0x05,0x02,0x1B,0x81,0x00,0x0A,0x00,0x08,0x84,
0x20,0x10,0x02,0x18,0xE1,0x01,0x28,0x01,0x0A,0x20,0x41,0x45,0x38,0x32,0x44,0x36,
0x32,0x35,0x32,0x31,0x42,0x43,0x34,0x41,0x31,0x32,0x39,0x34,0x33,0x34,0x44,0x31,
0x38,0x30,0x37,0x42,0x46,0x35,0x38,0x33,0x32,0x45, 0x12,0x0A,0x43,0x61,0x72,0x64,0x69,0x6F,0x6C,0x6F,0x67,0x79, 0x1A,0x01,0x31,
0x22,0x0C,0x70,0x69,0x64,0x39,0x30,0x39,0x38,0x37,0x36,0x31,0x32,0x33,0x2A,0x07,
0x76,0x69,0x64,0x31,0x32,0x33,0x34,0x32,0x03,0x44,0x6F,0x65,0x3A,0x04,0x4A,0x6F,
0x68,0x6E,0x40,0x01,0x48,0x21,0x50,0x01,0x5D,0x00,0x00,0x2E,0x43,0x65,0x00,0x00,
0xA6,0x42,0x68,0x03,0x81,0x01,0xE0,0xD7,0x24,0x88,0x99,0x01,0x00,0x00
};


        byte[] e = new byte[]
{

0x02,0x00,0x00,0x2B,0x00,0x27,0xD0,0x39,0x57,0x08,0xD4,0x81,0x08,0x00,0x45,0x00,
0x00,0xAD,0x85,0x88,0x40,0x00,0x80,0x06,0xF1,0x26,0xC0,0xA8,0x01,0x23,0xC0,0xA8,
0x01,0x28,0x26,0xAF,0x26,0xAF,0x76,0x42,0xCB,0x5C,0x01,0x4B,0xAF,0x78,0x50,0x18,
0xFB,0x79,0xA5,0x41,0x00,0x00,0xFA,0x05, 0x7C,0x08,0x84,0x00,0x0A,0x00,0x08,0x84,
0x20,0x10,0x02,0x18,0xE1,0x01,0x28,0x01,0x0A,0x20,0x41,0x45,0x38,0x32,0x44,0x36,
0x32,0x35,0x32,0x31,0x42,0x43,0x34,0x41,0x31,0x32,0x39,0x34,0x33,0x34,0x44,0x31,
0x38,0x30,0x37,0x42,0x46,0x35,0x38,0x33,0x32,0x45,0x12,0x0A,0x43,0x61,0x72,0x64,
0x69,0x6F,0x6C,0x6F,0x67,0x79, 0x1A,0x04,0x31,0x30,0x31,0x41, 0x22,0x0C,0x70,
0x69,0x64,0x39,0x30,0x39,0x38,0x37,0x36,0x31,0x32,0x33,0x2A,0x07,0x76,0x69,0x64,
0x31,0x32,0x33,0x34,0x32,0x03,0x44,0x6F,0x65,0x3A,0x04,0x4A,0x6F,0x68,0x6E,0x40,
0x01,0x48,0x21,0x50,0x01,0x5D,0x00,0x00,0x2E,0x43,0x65,0x00,0x00,0xA6,0x42,0x68,
0x03,0x81,0x01,0xE0,0xD7,0x24,0x88,0x99,0x01,0x00,0x00
};


        byte[] r = new byte[]
{

        0x02,0x00,0x00,0x2B,0x00,0x27,0xD0,0x39,0x57,0x08,0xD4,0x81,0x08,0x00,0x45,0x00,
0x00,0xAD,0x85,0x88,0x40,0x00,0x80,0x06,0xF1,0x26,0xC0,0xA8,0x01,0x23,0xC0,0xA8,
0x01,0x28,0x26,0xAF,0x26,0xAF,0x76,0x42,0xCB,0x5C,0x01,0x4B,0xAF,0x78,0x50,0x18,
0xFB,0x79,0xA5,0x41,0x00,0x00,0xFA,0x05, 0x09,0x2A ,0x7E,0x00,0x0A,0x00,0x08,0x84,
0x20,0x10,0x02,0x18,0xE1,0x01,0x28,0x01,0x0A,0x20,0x41,0x45,0x38,0x32,0x44,0x36,
0x32,0x35,0x32,0x31,0x42,0x43,0x34,0x41,0x31,0x32,0x39,0x34,0x33,0x34,0x44,0x31,
0x38,0x30,0x37,0x42,0x46,0x35,0x38,0x33,0x32,0x45,0x12,0x0A,0x43,0x61,0x72,0x64,
0x69,0x6F,0x6C,0x6F,0x67,0x79,0x1A,0x04,0x31,0x30,0x31,0x41, 0x22,0x06,0x31,0x32,0x33,0x34,0x35,0x36 , 0x2A,0x07,0x76,
0x69,0x64,0x31,0x32,0x33,0x34,0x32,0x03,0x44,0x6F,0x65,0x3A,0x04,0x4A,0x6F,0x68,
0x6E,0x40,0x01,0x48,0x21,0x50,0x01,0x5D,0x00,0x00,0x2E,0x43,0x65,0x00,0x00,0xA6,
0x42,0x68,0x03,0x81,0x01,0xE0,0xD7,0x24,0x88,0x99,0x01,0x00,0x00

};


        byte[] t = new byte[]
{

    0x02,0x00,0x00,0x2B,0x00,0x27,0xD0,0x39,0x57,0x08,0xD4,0x81,0x08,0x00,0x45,0x00,
0x00,0xAD,0x85,0x88,0x40,0x00,0x80,0x06,0xF1,0x26,0xC0,0xA8,0x01,0x23,0xC0,0xA8,
0x01,0x28,0x26,0xAF,0x26,0xAF,0x76,0x42,0xCB,0x5C,0x01,0x4B,0xAF,0x78,0x50,0x18,
0xFB,0x79,0xA5,0x41,0x00,0x00,0xFA,0x05, 0x3D,0x18,0x7E,0x00,0x0A,0x00,0x08,0x84,
0x20,0x10,0x02,0x18,0xE1,0x01,0x28,0x01,0x0A,0x20,0x41,0x45,0x38,0x32,0x44,0x36,
0x32,0x35,0x32,0x31,0x42,0x43,0x34,0x41,0x31,0x32,0x39,0x34,0x33,0x34,0x44,0x31,
0x38,0x30,0x37,0x42,0x46,0x35,0x38,0x33,0x32,0x45,0x12,0x0A,0x43,0x61,0x72,0x64,
0x69,0x6F,0x6C,0x6F,0x67,0x79,0x1A,0x04,0x31,0x30,0x31,0x41,0x22,0x06,0x31,0x32,
0x33,0x34,0x35,0x36,0x2A,0x07,0x76,0x69,0x64,0x31,0x32,0x33,0x34,0x32,0x03,0x44,
0x6F,0x65,0x3A,0x04,0x4A,0x6F,0x68,0x6E,0x40,0x01,0x48,0x2D,0x50,0x01,0x5D,0x00,
0x00,0x2E,0x43,0x65,0x00,0x00,0xA6,0x42,0x68,0x03,0x81,0x01,0xE0,0xD7,0x24,0x88,
0x99,0x01,0x00,0x00
};

        byte[] y = new byte[]
{
    0x02,0x00,0x00,0x2B,0x00,0x27,0xD0,0x39,0x57,0x08,0xD4,0x81,0x08,0x00,0x45,0x00,
0x00,0xAD,0x85,0x88,0x40,0x00,0x80,0x06,0xF1,0x26,0xC0,0xA8,0x01,0x23,0xC0,0xA8,
0x01,0x28,0x26,0xAF,0x26,0xAF,0x76,0x42,0xCB,0x5C,0x01,0x4B,0xAF,0x78,0x50,0x18,
0xFB,0x79,0xA5,0x41,0x00,0x00,0xFA,0x05, 0x74,0x8B,0x7E,0x00,0x0A,0x00,0x08,0x84,
0x20,0x10,0x02,0x18,0xE1,0x01,0x28,0x01,0x0A,0x20,0x41,0x45,0x38,0x32,0x44,0x36,
0x32,0x35,0x32,0x31,0x42,0x43,0x34,0x41,0x31,0x32,0x39,0x34,0x33,0x34,0x44,0x31,
0x38,0x30,0x37,0x42,0x46,0x35,0x38,0x33,0x32,0x45,0x12,0x0A,0x43,0x61,0x72,0x64,
0x69,0x6F,0x6C,0x6F,0x67,0x79,0x1A,0x04,0x31,0x30,0x31,0x41,0x22,0x06,0x31,0x32,
0x33,0x34,0x35,0x36,0x2A,0x07,0x76,0x69,0x64,0x31,0x32,0x33,0x34,0x32,0x03,0x44,
0x6F,0x65,0x3A,0x04,0x4A,0x6F,0x68,0x6E,0x40,0x01,0x48,0x2D,0x50,0x01,0x5D,0x00,
0x00,0x2F,0x43,0x65,0x00,0x00,0xA6,0x42,0x68,0x03,0x81,0x01,0xE0,0xD7,0x24,0x88,
0x99,0x01,0x00,0x00

};

        byte[] u = new byte[]
{

         0x02,0x00,0x00,0x2B,0x00,0x27,0xD0,0x39,0x57,0x08,0xD4,0x81,0x08,0x00,0x45,0x00,
0x00,0xAD,0x85,0x88,0x40,0x00,0x80,0x06,0xF1,0x26,0xC0,0xA8,0x01,0x23,0xC0,0xA8,
0x01,0x28,0x26,0xAF,0x26,0xAF,0x76,0x42,0xCB,0x5C,0x01,0x4B,0xAF,0x78,0x50,0x18,
0xFB,0x79,0xA5,0x41,0x00,0x00,0xFA,0x05, 0x7C,0x3C ,0x7E,0x00,0x0A,0x00,0x08,0x84,
0x20,0x10,0x02,0x18,0xE1,0x01,0x28,0x01,0x0A,0x20,0x41,0x45,0x38,0x32,0x44,0x36,
0x32,0x35,0x32,0x31,0x42,0x43,0x34,0x41,0x31,0x32,0x39,0x34,0x33,0x34,0x44,0x31,
0x38,0x30,0x37,0x42,0x46,0x35,0x38,0x33,0x32,0x45,0x12,0x0A,0x43,0x61,0x72,0x64,
0x69,0x6F,0x6C,0x6F,0x67,0x79,0x1A,0x04,0x31,0x30,0x31,0x41,0x22,0x06,0x31,0x32,
0x33,0x34,0x35,0x36,0x2A,0x07,0x76,0x69,0x64,0x31,0x32,0x33,0x34,0x32,0x03,0x44,
0x6F,0x65,0x3A,0x04,0x4A,0x6F,0x68,0x6E,0x40,0x01,0x48,0x2D,0x50,0x01,0x5D,0x00,
0x00,0x2F,0x43,0x65,0x00,0x00, 0x8C,0x42 ,0x68,0x03,0x81,0x01,0xE0,0xD7,0x24,0x88,
0x99,0x01,0x00,0x00
};




   

        await Task.Delay(2000);
        stream.WriteAsync(q, 0, q.Length);

        await Task.Delay(2000);
        stream.WriteAsync(w, 0, w.Length);

        await Task.Delay(2000);
        stream.WriteAsync(e, 0, e.Length);

        await Task.Delay(2000);
        stream.WriteAsync(r, 0, r.Length);

        await Task.Delay(2000);
        stream.WriteAsync(t, 0, t.Length);

        await Task.Delay(2000);

        stream.WriteAsync(y, 0, y.Length);

        await Task.Delay(2000);
        stream.WriteAsync(u, 0, u.Length);






        stream.Flush();






        Console.WriteLine("[>] Hasta bilgisi paketi gönderildi!");





        // === Bitir ===
        client.Close();
        listener.Stop();
        Console.WriteLine("[x] Bağlantı kapatıldı.");
    }



    static byte[] BuildPatientFrame(VariantConfig cfg)
    {
        // patient payload (departman/yatak/pid/visit sabit tutuluyor)
        using var payloadWriter = new ProtoWriter();
        payloadWriter.WriteFieldString(1, "AE82D62521BC4A129434D1807BF5832E");  // token
        payloadWriter.WriteFieldString(2, "Cardiology");                       // department
        payloadWriter.WriteFieldString(3, "101A");                             // bed
        payloadWriter.WriteFieldString(4, "123456");                           // pid
        payloadWriter.WriteFieldString(5, "vid1234");                          // visitId
        payloadWriter.WriteFieldString(6, cfg.LastName);                       // lastName
        payloadWriter.WriteFieldString(7, cfg.FirstName);                      // firstName
        payloadWriter.WriteFieldString(8, $"{cfg.FirstName} {cfg.LastName}".Trim());
        payloadWriter.WriteFieldVarint(9, (ulong)cfg.Age);
        payloadWriter.WriteFieldVarint(10, 1);                                 // age unit = years
        payloadWriter.WriteFieldFloat32(11, cfg.Height);
        payloadWriter.WriteFieldFloat32(12, cfg.Weight);
        payloadWriter.WriteFieldVarint(13, (ulong)cfg.BloodType);
        long admitMillis = new DateTimeOffset(new DateTime(2025, 9, 26, 22, 29, 0, DateTimeKind.Utc)).ToUnixTimeMilliseconds();
        payloadWriter.WriteFieldFixed64(16, (ulong)admitMillis);
        byte[] payload = payloadWriter.ToArray();

        // header
        using var headerWriter = new ProtoWriter();
        headerWriter.WriteFieldVarint(1, 4100);
        headerWriter.WriteFieldVarint(2, 2);
        headerWriter.WriteFieldVarint(3, cfg.Sequence);
        headerWriter.WriteFieldVarint(5, 1);
        byte[] header = headerWriter.ToArray();

        short headerLen = (short)header.Length;
        short totalLength = (short)(headerLen + payload.Length + 4);
        byte[] totalLenBytes = BitConverter.GetBytes(totalLength);
        byte[] headerLenBytes = BitConverter.GetBytes(headerLen);

        var crcData = new byte[
            totalLenBytes.Length +
            headerLenBytes.Length +
            header.Length +
            payload.Length];

        Buffer.BlockCopy(totalLenBytes, 0, crcData, 0, totalLenBytes.Length);
        Buffer.BlockCopy(headerLenBytes, 0, crcData, totalLenBytes.Length, headerLenBytes.Length);
        Buffer.BlockCopy(header, 0, crcData, totalLenBytes.Length + headerLenBytes.Length, header.Length);
        Buffer.BlockCopy(payload, 0, crcData, totalLenBytes.Length + headerLenBytes.Length + header.Length, payload.Length);

        ushort crc = Crc16.ComputeCcitt(crcData);

        var frame = new byte[4 + crcData.Length];
        frame[0] = 0xFA;
        frame[1] = 0x05;
        frame[2] = (byte)(crc & 0xFF);
        frame[3] = (byte)(crc >> 8);
        Buffer.BlockCopy(crcData, 0, frame, 4, crcData.Length);

        return frame; // 126 bayt MHCP çerçevesi
    }

    public static byte[] BuildPatientInfoPayload(float kilo)
    {
        // Orijinal bytelist (örnek: kilo 83 için)
        byte[] payload = new byte[]
        {
        0x02,0x00,0x00,0x2B,0x00,0x27,0xD0,0x39,0x57,0x08,0xD4,0x81,0x08,0x00,0x45,0x00,
        0x00,0xAD,0x85,0x88,0x40,0x00,0x80,0x06,0xF1,0x26,0xC0,0xA8,0x01,0x23,0xC0,0xA8,
        0x01,0x28,0x26,0xAF,0x26,0xAF,0x76,0x42,0xCB,0x5C,0x01,0x4B,0xAF,0x78,0x50,0x18,
        0xFB,0x79,0xA5,0x41,0x00,0x00,0xFA,0x05,0x74,0x8B,0x7E,0x00,0x0A,0x00,0x08,0x84,
        0x20,0x10,0x02,0x18,0xE1,0x01,0x28,0x01,0x0A,0x20,0x41,0x45,0x38,0x32,0x44,0x36,
        0x32,0x35,0x32,0x31,0x42,0x43,0x34,0x41,0x31,0x32,0x39,0x34,0x33,0x34,0x44,0x31,
        0x38,0x30,0x37,0x42,0x46,0x35,0x38,0x33,0x32,0x45,0x12,0x0A,0x43,0x61,0x72,0x64,
        0x69,0x6F,0x6C,0x6F,0x67,0x79,0x1A,0x04,0x31,0x30,0x31,0x41,0x22,0x06,0x31,0x32,
        0x33,0x34,0x35,0x36,0x2A,0x07,0x76,0x69,0x64,0x31,0x32,0x33,0x34,0x32,0x03,0x44,
        0x6F,0x65,0x3A,0x04,0x4A,0x6F,0x68,0x6E,0x40,0x01,0x48,0x2D,0x50,0x01,0x5D,0x00,
        0x00,0x2F,0x43,0x65,0x00,0x00,0xA6,0x42,0x68,0x03,0x81,0x01,0xE0,0xD7,0x24,0x88,
        0x99,0x01,0x00,0x00
        };

        // Kilo bilgisinin geçtiği offset (0xA6,0x42,0x68,0x03) -> 0xA6,0x42 = 83.0f
        // Offset: sondan 12. ve 11. byte (payload.Length - 12 ve payload.Length - 11)
        int kiloOffset = payload.Length - 12;

        // Kilo bilgisini float'tan IEEE 754 little endian byte dizisine çevir
        byte[] kiloBytes = BitConverter.GetBytes(kilo);

        // Eğer sistem big endian ise, ters çevir
        if (!BitConverter.IsLittleEndian)
            Array.Reverse(kiloBytes);

        // Kilo bilgisini payload'a yaz
        payload[kiloOffset + 0] = kiloBytes[0];
        payload[kiloOffset + 1] = kiloBytes[1];
        payload[kiloOffset + 2] = kiloBytes[2];
        payload[kiloOffset + 3] = kiloBytes[3];

        return payload;
    }

}
