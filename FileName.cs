using System;

public static class DynamicPayloadBuilder
{
    // CRC32 tablosu (standart polynomial 0xEDB88320)
    private static readonly uint[] Crc32Table = new uint[256];

    static DynamicPayloadBuilder()
    {
        const uint poly = 0xEDB88320;
        for (uint i = 0; i < 256; i++)
        {
            uint crc = i;
            for (int j = 0; j < 8; j++)
                crc = (crc & 1) != 0 ? (crc >> 1) ^ poly : crc >> 1;
            Crc32Table[i] = crc;
        }
    }

    public static uint ComputeCrc32(byte[] data, int offset, int length)
    {
        uint crc = 0xFFFFFFFF;
        for (int i = offset; i < offset + length; i++)
            crc = (crc >> 8) ^ Crc32Table[(crc ^ data[i]) & 0xFF];
        return ~crc;
    }

    public static byte[] BuildPatientInfoPayload(float kilo)
    {
        // Orijinal bytelist (kilo 83 için)
        byte[] payload = new byte[]
        {
            0x02,0x00,0x00,0x2B,0x00,0x27,0xD0,0x39,0x57,0x08,0xD4,0x81,0x08,0x00,0x45,0x00,
            0x00,0xAD,0x85,0x88,0x40,0x00,0x80,0x06,0xF1,0x26,0xC0,0xA8,0x01,0x23,0xC0,0xA8,
            0x01,0x28,0x26,0xAF,0x26,0xAF,0x76,0x42,0xCB,0x5C,0x01,0x4B,0xAF,0x78,0x50,0x18,
            0xFB,0x79,0xA5,0x41,0x00,0x00,0xFA,0x05,0x74,0x8B,0x7E,0x00,0x0A,0x00,0x08,0x84,
            0x20,0x10,0x02,0x18,0xE1,0x01,0x28,0x01,0x0A,0x20,0x41,0x45,0x38,0x32,0x44,0x36,
            0x32,0x35,0x32,0x31,0x42,0x43,0x34,0x41,0x31,0x32,0x39,0x34,0x33,0x34,0x44,0x31,
            0x38,0x30,0x37,0x42,0x46,0x35,0x38,0x33,0x32,0x45,0x12,0x0A,0x43,0x61,0x72,0x64,
            0x69,0x6F,0x6C,0x6F,0x67,0x79,0x1A,0x04,0x31,0x30,0x31,0x41,0x22,0x06,0x31,0x32,
            0x33,0x34,0x35,0x36,0x2A,0x07,0x76,0x69,0x64,0x31,0x32,0x33,0x34,0x32,0x03,0x44,
            0x6F,0x65,0x3A,0x04,0x4A,0x6F,0x68,0x6E,0x40,0x01,0x48,0x2D,0x50,0x01,0x5D,0x00,
            0x00,0x2F,0x43,0x65,0x00,0x00,0xA6,0x42,0x68,0x03,0x81,0x01,0xE0,0xD7,0x24,0x88,
            0x99,0x01,0x00,0x00
        };

        // Kilo bilgisinin geçtiği offset (0xA6,0x42,0x68,0x03) -> 0xA6,0x42 = 83.0f
        int kiloOffset = payload.Length - 12;

        // Kilo bilgisini float'tan IEEE 754 little endian byte dizisine çevir
        byte[] kiloBytes = BitConverter.GetBytes(kilo);
        if (!BitConverter.IsLittleEndian)
            Array.Reverse(kiloBytes);

        // Kilo bilgisini payload'a yaz
        payload[kiloOffset + 0] = kiloBytes[0];
        payload[kiloOffset + 1] = kiloBytes[1];
        payload[kiloOffset + 2] = kiloBytes[2];
        payload[kiloOffset + 3] = kiloBytes[3];

        // CRC alanı: kilo bilgisinden hemen önceki 4 byte (örneğin payload.Length - 16)
        int crcOffset = payload.Length - 16;
        int crcLength = payload.Length - 16; // CRC'nin hesaplanacağı alan (CRC ve sonrası hariç)

        // CRC'yi hesapla
        uint crc = ComputeCrc32(payload, 0, crcLength);

        // CRC'yi payload'a little endian olarak yaz
        payload[crcOffset + 0] = (byte)(crc & 0xFF);
        payload[crcOffset + 1] = (byte)((crc >> 8) & 0xFF);
        payload[crcOffset + 2] = (byte)((crc >> 16) & 0xFF);
        payload[crcOffset + 3] = (byte)((crc >> 24) & 0xFF);

        return payload;
    }
}